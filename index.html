<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuakeViewer</title>
    <style>
        body {
            background-color: black;
            color: white;
            font-size: 30px;
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        #quake-info {
            max-height: 80vh;
            overflow-y: auto;
            text-align: left;
            margin: 0 auto;
            width: 80%;
        }
        #reload {
            position: fixed;
            bottom: 10px;
            right: 10px;
            cursor: pointer;
        }
        #version {
            position: fixed;
            bottom: 10px;
            left: 10px;
            font-size: 10px;
            color: white;
        }
        #morequake-warning {
            color: red;
            font-size: 12px;
            margin-top: 5px;
        }
        #quake-selector {
            position: fixed;
            top: 10px;
            left: 10px;
            cursor: pointer;
            padding: 5px;
            background-color: white;
            color: black;
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <div id="quake-info"></div>
    <img id="reload" src="reload.png" alt="Reload" width="50" height="50" onclick="manualFetchQuakeData()">
    <div id="version">
        <span id="viewer-type">QuakeViewer Version1.1</span>
        <div id="morequake-warning"></div>
    </div>
    <audio id="quake-sound" src="quakeinfo.mp3" preload="auto"></audio>
    <div id="quake-selector" style="display: none;" onclick="showPastQuakes()">地震選択</div>

    <script>
        const quakeInfoDiv = document.getElementById('quake-info');
        const quakeSound = document.getElementById('quake-sound');
        const viewerTypeSpan = document.getElementById('viewer-type');
        const morequakeWarningDiv = document.getElementById('morequake-warning');
        const quakeSelectorDiv = document.getElementById('quake-selector');
        let latestQuakeTime = null;
        const urlParams = new URLSearchParams(window.location.search);

        function fetchQuakeData(playSound = false) {
            fetch('https://api.p2pquake.net/v2/history?codes=551')
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const latestQuake = data[0];
                        const newQuakeTime = new Date(latestQuake.time).getTime();
                        if (newQuakeTime !== latestQuakeTime) {
                            latestQuakeTime = newQuakeTime;
                            displayQuakeInfo(latestQuake);
                            if (playSound) {
                                quakeSound.play();
                            }
                        }
                    }
                })
                .catch(error => console.error('Error fetching quake data:', error));
        }

        function manualFetchQuakeData() {
            fetchQuakeData(true);
        }

        function displayQuakeInfo(quake) {
            const time = new Date(quake.time);
            const formattedTime = `${time.getHours()}時${time.getMinutes()}分ごろ`;
            const intensity = quake.earthquake.maxScale / 10;
            const place = quake.earthquake.hypocenter.name || '不明';
            const depth = quake.earthquake.hypocenter.depth || '不明';
            const magnitude = quake.earthquake.hypocenter.magnitude || '不明';

            let quakeInfoHtml = `
                ${formattedTime}、最大震度${intensity}を観測する地震がありました。<br>
                震源地は${place}、震源の深さは${depth}km、地震の規模を示すマグニチュードは${magnitude}と推定されます。
                <br><br>`;

            const sortedPoints = quake.points.sort((a, b) => b.scale - a.scale);

            sortedPoints.forEach(point => {
                const areaIntensity = point.scale / 10;
                quakeInfoHtml += `[震度${areaIntensity}] ${point.pref} ${point.addr}<br>`;
            });

            quakeInfoDiv.innerHTML = quakeInfoHtml;
        }

        function changeFontSize() {
            const newSize = prompt('New Font Size: (px):');
            if (newSize) {
                document.body.style.fontSize = newSize + 'px';
            }
        }

        function showPastQuakes() {
            fetch('https://api.p2pquake.net/v2/history?codes=551')
                .then(response => response.json())
                .then(data => {
                    let pastQuakeInfoHtml = '';
                    data.forEach(quake => {
                        const time = new Date(quake.time);
                        const formattedTime = `${time.getFullYear()}年${time.getMonth() + 1}月${time.getDate()}日 ${time.getHours()}時${time.getMinutes()}分ごろ`;
                        const intensity = quake.earthquake.maxScale / 10;
                        const place = quake.earthquake.hypocenter.name || '不明';
                        const depth = quake.earthquake.hypocenter.depth || '不明';
                        const magnitude = quake.earthquake.hypocenter.magnitude || '不明';

                        pastQuakeInfoHtml += `
                            ${formattedTime}、最大震度${intensity}を観測する地震がありました。<br>
                            震源地は${place}、震源の深さは${depth}km、地震の規模を示すマグニチュードは${magnitude}と推定されます。
                            <br><br>`;
                    });
                    quakeInfoDiv.innerHTML = pastQuakeInfoHtml;
                })
                .catch(error => console.error('Error fetching past quake data:', error));
        }

        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.altKey && event.key === '0') {
                changeFontSize();
            }
        });

        if (urlParams.get('MoreQuake') === 'view') {
            viewerTypeSpan.innerHTML = 'MoreQuake Viewer';
            morequakeWarningDiv.innerHTML = 'MoreQuake Viewerでは最新地震を受信できません。';
            quakeSelectorDiv.style.display = 'block';
            showPastQuakes();
        } else {
            setInterval(() => fetchQuakeData(false), 30000);
            fetchQuakeData(false);
        }
    </script>
</body>
</html>
